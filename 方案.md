# 微信小程序点单系统方案

## 项目概述
本项目是一个基于微信小程序的点单系统，类似于奶茶店的点单小程序，支持菜单管理、用户下单、店家接收订单等核心功能。

## 功能需求

### 1. 菜单管理功能
- **添加菜单项**：支持添加商品名称、价格、描述、图片等信息
- **编辑菜单项**：修改现有商品信息
- **删除菜单项**：移除不需要的商品
- **分类管理**：支持商品分类（如饮品、小食等）
- **商品状态**：支持上架/下架状态切换

### 2. 用户下单功能
- **浏览菜单**：用户可以查看所有可用商品
- **商品详情**：查看商品详细信息和图片
- **购物车**：添加商品到购物车，支持数量调整
- **下单流程**：填写用户信息、选择取餐时间等
- **订单确认**：显示订单详情和总价
- **提交订单**：直接提交订单无需支付

### 3. 店家订单管理
- **订单接收**：实时接收用户下单信息
- **订单状态**：管理订单状态（待处理、制作中、已完成等）
- **订单详情**：查看订单详细信息
- **订单统计**：日/周/月订单统计

### 4. 系统通知功能
- **下单通知**：用户下单后向店家发送通知
- **订单状态通知**：订单状态变化时通知用户
- **模板消息**：使用微信小程序模板消息功能

## 技术架构

### 前端架构
- **框架**：微信小程序原生框架
- **组件化**：封装可复用的UI组件
- **状态管理**：使用全局数据管理订单和用户状态
- **UI设计**：采用微信小程序设计规范

### 后端架构
- **本地服务**：开发阶段使用本地API服务（Node.js + Express）
- **数据库**：本地数据库存储商品、订单、用户信息（SQLite/MySQL）
- **API接口**：RESTful API处理业务逻辑和数据操作
- **文件存储**：本地文件系统存储商品图片
- **云开发迁移**：上线时平滑迁移到微信小程序云开发服务

## 数据库设计

### 商品表 (products)
```javascript
{
  _id: "商品ID",
  name: "商品名称",
  price: 价格,
  description: "商品描述",
  image: "商品图片URL",
  category: "商品分类",
  status: "上架状态", // available/unavailable
  createTime: "创建时间",
  updateTime: "更新时间"
}
```

### 订单表 (orders)
```javascript
{
  _id: "订单ID",
  orderNo: "订单编号",
  userId: "用户ID",
  userInfo: {
    name: "用户姓名",
    phone: "联系电话"
  },
  items: [
    {
      productId: "商品ID",
      name: "商品名称",
      price: 价格,
      quantity: 数量,
      subtotal: 小计
    }
  ],
  totalAmount: 总金额,
  status: "订单状态", // pending/processing/completed/cancelled
  pickupTime: "取餐时间",
  createTime: "下单时间",
  updateTime: "更新时间"
}
```

### 分类表 (categories)
```javascript
{
  _id: "分类ID",
  name: "分类名称",
  sort: 排序,
  status: "状态"
}
```

## 页面结构

### 用户端页面
1. **首页 (index)**
   - 商品分类展示
   - 推荐商品
   - 购物车入口

2. **商品列表页 (menu)**
   - 分类筛选
   - 商品列表展示
   - 加入购物车功能

3. **商品详情页 (product)**
   - 商品详细信息
   - 商品图片
   - 规格选择

4. **购物车页 (cart)**
   - 购物车商品列表
   - 数量调整
   - 结算功能

5. **下单页 (order)**
   - 用户信息填写
   - 取餐时间选择
   - 订单确认
   - 提交订单

6. **订单列表页 (orders)**
   - 历史订单查看
   - 订单状态跟踪

7. **订单详情页 (order-detail)**
   - 订单详细信息
   - 订单状态

### 管理端页面
1. **管理首页 (admin)**
   - 今日订单统计
   - 快捷操作入口

2. **菜单管理页 (admin/menu)**
   - 商品列表
   - 添加/编辑商品
   - 商品状态管理

3. **订单管理页 (admin/orders)**
   - 订单列表
   - 订单状态更新
   - 订单详情查看

4. **分类管理页 (admin/categories)**
   - 分类列表
   - 添加/编辑分类

## 核心功能实现

### 1. 菜单管理
- 使用本地数据库存储商品信息
- 支持图片上传到本地服务器
- 实现商品的增删改查API接口
- 分类管理和商品关联

### 2. 下单流程
- 购物车本地存储
- 订单信息收集
- 调用本地API创建订单
- 直接提交订单完成下单

### 3. 订单通知
- 使用微信小程序订阅消息
- 本地服务器触发消息推送
- 店家端实时订单提醒（WebSocket或轮询）

### 4. 状态管理
- 全局状态管理购物车
- 用户登录状态管理
- 订单状态同步更新

## 微信小程序API使用

### 1. 用户授权
- `wx.getUserProfile()` - 获取用户信息
- `wx.login()` - 获取登录凭证

### 2. 消息通知
- `wx.requestSubscribeMessage()` - 订阅消息
- 模板消息推送

### 3. 数据存储
- `wx.setStorageSync()` - 本地存储
- `wx.request()` - 调用本地API接口

### 4. 图片处理
- `wx.chooseImage()` - 选择图片
- `wx.uploadFile()` - 上传图片到本地服务器

## 开发计划

### 第一阶段：基础框架搭建
1. 页面结构创建
2. 基础组件封装
3. 本地服务器环境搭建（Node.js + Express）
4. 数据库设计实现（SQLite/MySQL）
5. API接口设计

### 第二阶段：核心功能开发
1. 菜单管理功能
2. 用户下单流程
3. 购物车功能
4. 订单管理

### 第三阶段：高级功能
1. 消息通知系统
2. 数据统计分析
3. 性能优化
4. 用户体验优化

### 第四阶段：测试与发布
1. 功能测试
2. 性能测试
3. 用户体验优化
4. 小程序发布

## 本地服务器技术栈

### 后端服务
- **Node.js + Express**：构建RESTful API服务
- **数据库**：SQLite（开发）/ MySQL（生产）
- **文件上传**：multer处理图片上传
- **跨域处理**：cors中间件
- **数据验证**：joi参数验证

### API接口设计
```javascript
// 商品相关
GET    /api/products          // 获取商品列表
POST   /api/products          // 添加商品
PUT    /api/products/:id      // 更新商品
DELETE /api/products/:id      // 删除商品

// 分类相关
GET    /api/categories        // 获取分类列表
POST   /api/categories        // 添加分类

// 订单相关
GET    /api/orders            // 获取订单列表
POST   /api/orders            // 创建订单
PUT    /api/orders/:id        // 更新订单状态

// 文件上传
POST   /api/upload            // 上传图片
```

### 数据库表结构（SQL）
```sql
-- 商品表
CREATE TABLE products (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name VARCHAR(100) NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  description TEXT,
  image VARCHAR(255),
  category_id INTEGER,
  status VARCHAR(20) DEFAULT 'available',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 分类表
CREATE TABLE categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name VARCHAR(50) NOT NULL,
  sort INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active'
);

-- 订单表
CREATE TABLE orders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_no VARCHAR(50) UNIQUE NOT NULL,
  user_id VARCHAR(50),
  user_name VARCHAR(50),
  user_phone VARCHAR(20),
  total_amount DECIMAL(10,2),
  status VARCHAR(20) DEFAULT 'pending',
  pickup_time DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 订单详情表
CREATE TABLE order_items (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_id INTEGER,
  product_id INTEGER,
  product_name VARCHAR(100),
  price DECIMAL(10,2),
  quantity INTEGER,
  subtotal DECIMAL(10,2)
);
```

## 云开发迁移策略

### 迁移准备
1. **数据抽象层**：创建统一的数据访问接口
2. **配置管理**：环境变量区分本地/云开发
3. **API适配器**：封装不同环境的API调用方式

### 迁移步骤
1. **数据迁移**：将本地数据库数据导入云数据库
2. **图片迁移**：将本地图片上传到云存储
3. **API切换**：修改小程序端API调用地址
4. **功能验证**：确保所有功能正常运行

### 代码兼容性设计
```javascript
// 小程序端 - 统一的API调用封装
const API_BASE = process.env.NODE_ENV === 'development' 
  ? 'http://localhost:3000/api' 
  : 'cloud://your-env.your-domain';

// 统一的数据访问方法
const apiRequest = (url, data, method = 'GET') => {
  if (process.env.NODE_ENV === 'development') {
    // 本地API调用
    return wx.request({
      url: `${API_BASE}${url}`,
      data,
      method,
      header: { 'Content-Type': 'application/json' }
    });
  } else {
    // 云函数调用
    return wx.cloud.callFunction({
      name: 'api',
      data: { url, data, method }
    });
  }
};
```

## 注意事项

1. **权限管理**：区分普通用户和管理员权限
2. **数据安全**：敏感数据加密存储
3. **性能优化**：图片压缩、懒加载等
4. **用户体验**：流畅的交互动画和反馈
5. **错误处理**：完善的错误提示和处理机制
6. **兼容性**：确保在不同设备上的兼容性
7. **平滑迁移**：保证从本地服务到云开发的无缝切换

## 预期效果

完成后的小程序将具备完整的点单功能，用户可以方便地浏览菜单、下单支付，店家可以高效地管理菜单和处理订单，提升整体的服务效率和用户体验。 